var NutcacheAttachmentFunctions={observers:new Array(),notifyObservers:function(){if(NutcacheAttachmentFunctions.observers!=null&&NutcacheAttachmentFunctions.observers.length>0){$.each(NutcacheAttachmentFunctions.observers,function(){this()})}},NutcacheAttachmentDataObject:function(){},initializeNutcacheAttachment:function(a){NutcacheAttachmentFunctions.NutcacheAttachmentDataObject.prototype.setFileUploadData=function(c,b){$(c).data("attachmentData",b)};NutcacheAttachmentFunctions.NutcacheAttachmentDataObject.prototype.getFileUploadData=function(b){return $(b).data("attachmentData")};NutcacheAttachmentFunctions.NutcacheAttachmentDataObject.prototype.addLoadingPanel=function(b){var c=this.loadingTemplate.clone();c.find("a.attachment-title").text(b.rawFile.name);c.attr("data-attachment-identifier",b.uid);this.setFileUploadData(c,{fileSize:b.rawFile.size});this.loadingFiles[b.uid]={panel:c,size:b.rawFile.size};return c};NutcacheAttachmentFunctions.NutcacheAttachmentDataObject.prototype.getSingleAttachmentData=function(c){var b=this.getFileUploadData(c);if(b==undefined){return undefined}var d={AttachmentId:b.id,RelationAttachmentId:b.attachmentRelationId,TemporaryFileKey:b.temporaryFileKey,FileName:b.fileName,FileSize:b.fileSize,FileType:b.fileType,VisibleToCustomer:null,TemporaryUrl:b.temporaryUrl,IsDeleted:c.find("input[name=IsDeleted]").val(),AttachDate:c.find("input[name=AttachDate]").val(),UserWhoAttachedFileFullName:b.userWhoAttachedFileFullName,AttachmentIdentifier:c.data("attachment-identifier")};var e=c.find("input[type=checkbox][name=VisibleToCustomer]");if(e.length){d.VisibleToCustomer=c.find("input[name=VisibleToCustomer]").is(":checked")}else{d.VisibleToCustomer=c.find("input[name=VisibleToCustomer]").val()}return d};NutcacheAttachmentFunctions.NutcacheAttachmentDataObject.prototype.deleteElement=function(d,f,e){var c=this,b=$(d).closest("div.attachment-container");OpenDeleteDialogWindow(f,e,function(){c.onDeleteConfirmed(b)})};NutcacheAttachmentFunctions.NutcacheAttachmentDataObject.prototype.updateCoverState=function(d,e){var c=this,b=$(d).closest("div.attachment-container");c.onUpdateCoverState(b,e)};NutcacheAttachmentFunctions.NutcacheAttachmentDataObject.prototype.toggleCustomerVisibility=function(d){var c=this,b=$(d).closest("div.attachment-container");c.onToggleCustomerVisibility(b.data("id"),$(d).is(":checked"))};if(a==undefined){return $($(this).data("kendoUpload")).data("nutcacheAttachmentData")}this.each(function(f,j){var g=$(j);var h=g.data("kendoUpload");if(h==undefined){var b=g.closest(":data(nutcacheAttachmentHandler)");if(b.length){var c=b.data("nutcacheAttachmentHandler");a.attachmentDeleteFunction=function(){c.deleteElement.apply(c,arguments)};a.attachmentUpdateCoverFunction=function(){c.updateCoverState.apply(c,arguments)};a.attachmentToggleCustomerVisibilityFunction=function(){c.toggleCustomerVisibility.apply(c,arguments)};c.setFileUploadData(g,a)}return}var i=$.extend(new NutcacheAttachmentFunctions.NutcacheAttachmentDataObject(),{attachmentContainer:null,emptyTemplate:"div.attachment-empty-template",loadingTemplate:'div.attachment-loading-template[data-attachment-identifier=""]',loadingFiles:{},onUploadStarted:null,onUploadSucceeded:null,onUploadFailed:null,onDeleteConfirmed:null,customMessageAction:null,availableBytes:0,maxFileSizeInBytes:0,storageLimitReachedWarning:{title:"",text:""},fileSizeLimitReachedWarning:{title:"",text:""}},a);h.bind("upload",NutcacheAttachmentFunctions.onUpload);h.bind("success",NutcacheAttachmentFunctions.onUploadSuccess);h.bind("error",NutcacheAttachmentFunctions.onUploadError);h.bind("complete",NutcacheAttachmentFunctions.onComplete);i.attachmentContainer=$(i.attachmentContainer);i.loadingTemplate=$(i.loadingTemplate);var d=$(i.emptyTemplate);if(d.length&&i.loadingTemplate.length){NutcacheAttachmentFunctions.makeParentsVisibleAndCall(d,function(){i.loadingTemplate.height(d.height())})}i.attachmentContainer.data("nutcacheAttachmentHandler",i);var e=i.attachmentContainer,k=g.parents(".k-dropzone").find("em");if(e.length&&k.length){e.on("dragenter",function(){});e.on("dragover",function(l){l.stopPropagation();l.preventDefault()});e.on("dragleave",function(){});e.on("drop",function(l){l.stopPropagation();l.preventDefault();var m=jQuery.Event("drop");m.originalEvent=l.originalEvent;k.trigger(m)})}$(h).data("nutcacheAttachmentData",i)});return this},onUpload:function(a){var d=$(this).data("nutcacheAttachmentData");var f=d.attachmentContainer.find(".attachment-container[data-id=0], .attachment-loading-template");var g=0;f.each(function(){g+=parseFloat(d.getFileUploadData(this).fileSize)});var b=null;var c=a.files;$.each(c,function(){if(g+this.rawFile.size>d.availableBytes){b={title:d.storageLimitReachedWarning.title,text:d.storageLimitReachedWarning.text.replace("{0}",this.rawFile.name)}}else{if(this.rawFile.size>d.maxFileSizeInBytes){b={title:d.fileSizeLimitReachedWarning.title,text:d.fileSizeLimitReachedWarning.text.replace("{0}",this.rawFile.name)}}else{var e=d.addLoadingPanel.apply(d,[this]);e.insertBefore(d.attachmentContainer.find(".new-item"));e.show();a.data={uniqueIdentifier:this.uid};if(d.onUploadStarted!=undefined){d.onUploadStarted.call(this,a)}}}});if(b!=null){if(d.customMessageAction!=null){OpenCustomDialogWindow(b.title,b.text,d.customMessageAction.okButtonAction,d.customMessageAction.okButtonText,null,d.customMessageAction.cancelButtonText)}else{OpenSingleButtonDialogWindow(b.title,b.text)}a.preventDefault()}return b==null},onUploadSuccess:function(a){var b=$(this).data("nutcacheAttachmentData");if(b.onUploadSucceeded!=undefined){b.onUploadSucceeded.call(this,a);NutcacheAttachmentFunctions.notifyObservers()}},onUploadError:function(a){var c=$(this).data("nutcacheAttachmentData");if(c.onUploadFailed!=undefined){c.onUploadFailed.call(this,a)}var b=a.files;$.each(b,function(){var e=c.loadingFiles[this.uid].panel;delete c.loadingFiles[this.uid];e.remove();if(a!=undefined&&a.response!=undefined&&a.response.Messages!=undefined){LoadMessagesSection(a.response.Messages,"#floating-message-window")}else{var d=$("#uploadErrorText").val().replace("{0}",this.rawFile.name);ShowErrorMessages(d)}});a.preventDefault()},makeParentsVisibleAndCall:function(a,b){var c=a.parents().not(":visible");if(c.length==0){return b()}else{return $.swap(c[c.length-1],{width:"100%",position:"absolute",visibility:"hidden",display:"block"},NutcacheAttachmentFunctions.makeParentsVisibleAndCall,[a,b])}}};(function(a){a.fn.nutcacheAttachment=NutcacheAttachmentFunctions.initializeNutcacheAttachment;if(window.delayedPluginCalls!=undefined&&window.delayedPluginCalls.nutcacheAttachmentCalls!=undefined){window.delayedPluginCalls.nutcacheAttachmentCalls.forEach(function(b){NutcacheAttachmentFunctions.initializeNutcacheAttachment.apply(b.target,b.params)})}}(jQuery));var AttachmentFunctions={onUploadSuccess:function(a){var c=$(this).data("nutcacheAttachmentData");var d=$("<div>"+a.response.Content.attachmentElementPartialView+"</div>");if(a.response.Content.isTemporary){$("#attachmentsVersion").val(function(e,f){return ++f})}var b=a.files;$.each(b,function(){$("#uploadsInProgress").val(function(j,k){return --k});var h=$(d).find('div.attachment-container[data-attachment-identifier="'+this.uid+'"]');var g=c.loadingFiles[this.uid].panel;delete c.loadingFiles[this.uid];var f=h.find("div.attachment-loginof");var e=f.html().replace("##LOCALDATETIME##",Nutcache.Dates.ConvertUTCDateTimeToLocalDateTime(h.find('input[name="AttachDate"]').attr("value"),Nutcache.Dates.dateTimeFormatString));f.html(e);g.replaceWith(h);NutcacheAttachmentFunctions.notifyObservers()});LoadMessagesSection(a.response.messages,"#floating-message-window")},onUploadError:function(a){var b=a.files;$.each(b,function(){$("#uploadsInProgress").val(function(c,d){return --d})})},onUpload:function(a){$("#uploadsInProgress").val(function(b,c){return ++c});AttachmentFunctions.displayHideNoAttachmentSection()},saveAttachmentData:function(){var a=JSON.stringify(AttachmentFunctions.getAttachmentsData());$("#hideAttachmentData").val(a)},getAttachmentsData:function(){var a=new Array();if($("#selectedAttachments").length==0){return a}var c=$("#selectedAttachments").nutcacheAttachment();var b=c.attachmentContainer.find(".attachment-container");$.each(b,function(e,f){var d=c.getSingleAttachmentData($(this));if(d!=undefined){a.push(d)}});return a},removeAttachmentConfirmed:function(a){a.find("input[name=IsDeleted]").val("true");a.hide();AttachmentFunctions.displayHideNoAttachmentSection();NutcacheAttachmentFunctions.notifyObservers()},renderAttachmentList:function(b,a,d,c){Nutcache.Ajax.TryAjaxCall({url:GetUrl("Attachment")+a,contentType:"application/x-www-form-urlencoded; charset=UTF-8",type:"POST",data:{entityId:d,attachmentListViewModelJson:c},success:function(e){if(e.trim().length>0){var f=$(e);AttachmentFunctions.convertAttachDateToLocal(f);$("#"+b).html(f);AttachmentFunctions.displayHideNoAttachmentSection()}},error:ManageAjaxError})},displayHideNoAttachmentSection:function(){var b=NutcacheAttachmentFunctions.makeParentsVisibleAndCall($(".attachment-container"),function(){return $(".attachment-container:visible").length});$("[id=no-attachment-section]").css("display",b==0?"block":"none");var a=$("#selectedAttachments").data("kendoUpload");if(a){a.enable()}},convertAttachDateToLocal:function(a){a.find("div.attachment-container").each(function(){var c=$(this).find("div.attachment-loginof");if(c.length){var b=c.html().replace("##LOCALDATETIME##",Nutcache.Dates.ConvertUTCDateTimeToLocalDateTime($(this).find('input[name="AttachDate"]').attr("value"),Nutcache.Dates.dateTimeFormatString));c.html(b)}})}};