var InvoiceFunctions={currentEditRow:null,getInvoiceUrl:function(a){return GetUrl("Invoice")+(a!=null?a:"")},getCurrentInvoiceId:function(){return $(".main-header-section").data("id")},getServiceGrid:function(){return $("#gridInvoiceDetailServices").data("kendoGrid")},getProductGrid:function(){return $("#gridInvoiceDetailProducts").data("kendoGrid")},getGridFieldsDefinition:function(a){return a.dataSource.options.schema.model.fields},getCurrentGrid:function(a){var b=a!=null?a:InvoiceFunctions.currentEditRow;return $(b).closest(".k-grid").data("kendoGrid")},calculateTaxesAndTotal:function(){var d=InvoiceFunctions.getServiceGrid();var c=InvoiceFunctions.getProductGrid();var a=InvoiceFunctions.getCurrentInvoiceId();var b={invoiceId:typeof a!="undefined"?a:0,services:d!=null?d.dataItems():null,products:c!=null?c.dataItems():null};Nutcache.Ajax.TryAjaxCall({url:InvoiceFunctions.getInvoiceUrl("CalculateTaxesAndTotal"),contentType:"application/json; charset=UTF-8",type:"POST",data:JSON.stringify(b),dataType:"json",success:function(e){if(!e.IsSaved){ShowErrors(e)}else{$("div#invoice-total-division").html(e.PartialView)}},error:ManageAjaxError})},deleteInvoiceDetail:function(c){var b=$(c).closest(".k-grid").data("delete-title");var a=$(c).closest(".k-grid").data("delete-message");OpenDeleteDialogWindow(b,a,function(){InvoiceFunctions.deleteDetailConfirmed(c)},null)},deleteDetailConfirmed:function(c){var b=$(c).closest("tr");var a=InvoiceFunctions.getCurrentGrid(c);a.removeRow(b);InvoiceFunctions.calculateTaxesAndTotal()},refreshItemValues:function(b){var d=$(InvoiceFunctions.currentEditRow).index();var a=InvoiceFunctions.getCurrentGrid();var c=a.dataItems()[d];if(b!=null&&b.ID>0){c.ItemID=b.ID;c.ItemCode=b.Code;c.ItemDescription=b.Description;c.ItemPrice=b.SaleUnitRate;c.TotalItemPrice=c.ItemQuantity*c.ItemPrice;if(b.DefaultSaleTax!=null){c.TaxID=b.DefaultSaleTax.ID;c.TaxDescription=b.DefaultSaleTax.Description}InvoiceFunctions.calculateTaxesAndTotal()}else{c.ItemID=0;c.ItemCode=InvoiceFunctions.getGridFieldsDefinition(a).ItemCode.defaultValue}a.refresh()},refreshTaxValues:function(d){var c=$(InvoiceFunctions.currentEditRow).index();var a=InvoiceFunctions.getCurrentGrid();var b=a.dataItems()[c];if(d!=null&&d.ID>0){b.TaxID=d.ID;b.TaxDescription=d.Description}else{b.TaxID=0;b.TaxDescription=InvoiceFunctions.getGridFieldsDefinition(a).TaxDescription.defaultValue}InvoiceFunctions.calculateTaxesAndTotal();a.refresh()},refreshProjectValues:function(c){var d=$(InvoiceFunctions.currentEditRow).index();var a=InvoiceFunctions.getCurrentGrid();var b=a.dataItems()[d];if(c!=null&&c.ID>0){b.ProjectID=c.ID;b.ProjectCode=c.Code}else{b.ProjectID=0;b.ProjectCode=""}a.refresh()},clearProjectValues:function(a){var b=a.dataSource.options.schema.model.fields;$.each(a.dataItems(),function(c,d){d.ProjectID=b.ProjectID.defaultValue;d.ProjectCode=b.ProjectCode.defaultValue});a.refresh()},refreshCustomerValuesSuccess:function(b){$("#CustomerEmail").val("");$("#CustomerName").val("");$("#CustomerContact").val("");$("#CustomerAddress").val("");$("#CustomerCity").val("");$("#CustomerCountry").val("");$("#CustomerProvinceState").val("");$("#CustomerPostalZipCode").val("");$("#CustomerPhone").val("");$("#CustomerPhoneMobile").val("");$("#CustomerLegalNotice").val("");$(".invoicing-header-customer-info-fulladdress").html("");$(".invoicing-header-customer-info-edit").addClass("hidden");if(typeof b=="undefined"||b==null||b.Content==null){return}var a=b.Content.Customer;var c=b.Content.FormattedAddress;if(typeof a!="undefined"&&a!=null){$("#CustomerEmail").val(a.Email!=null?a.Email:"");$("#CustomerName").val(a.Name!=null?a.Name:"");$("#CustomerContact").val(a.Contact!=null?a.Contact:"");$("#CustomerAddress").val(a.Address!=null?a.Address:"");$("#CustomerCity").val(a.City!=null?a.City:"");$("#CustomerCountry").val(a.CountryName!=null?a.CountryName:"");$("#CustomerProvinceState").val(a.SubDivisionName!=null?a.SubDivisionName:"");$("#CustomerPostalZipCode").val(a.PostalZipCode!=null?a.PostalZipCode:"");$("#CustomerPhone").val(a.Phone!=null?a.Phone:"");$("#CustomerPhoneMobile").val(a.PhoneMobile!=null?a.PhoneMobile:"");$("#CustomerLegalNotice").val(a.LegalNotice!=null?a.LegalNotice:"");if(typeof c!="undefined"&&c!=null){$(".invoicing-header-customer-info-fulladdress").html(c);if(c.replace(new RegExp("<br />","g"),"")==""){$(".invoicing-header-customer-info-edit").addClass("hidden")}else{$(".invoicing-header-customer-info-edit").removeClass("hidden")}}else{$(".invoicing-header-customer-info-edit").addClass("hidden")}}},invoiceDetailGrid_Save:function(a){if(typeof a.values.ItemQuantity!="undefined"){a.model.ItemQuantity=a.values.ItemQuantity;a.model.TotalItemPrice=a.model.ItemQuantity*a.model.ItemPrice;a.preventDefault();a.sender.refresh();InvoiceFunctions.calculateTaxesAndTotal()}else{if(typeof a.values.ItemPrice!="undefined"){a.model.ItemPrice=a.values.ItemPrice;a.model.TotalItemPrice=a.model.ItemQuantity*a.model.ItemPrice;a.preventDefault();a.sender.refresh();InvoiceFunctions.calculateTaxesAndTotal()}else{if(typeof a.values.TaxID!="undefined"){a.preventDefault();if(a.values.TaxID==ID_NEW){TaxFunctions.showTaxPopupWindow(0,InvoiceFunctions.refreshTaxValues,null)}else{TaxFunctions.getTaxInformations(a.values.TaxID,InvoiceFunctions.refreshTaxValues)}}else{if(typeof a.values.ItemID!="undefined"){a.preventDefault();var b=$(a.container).closest(".k-grid").data("item-type");if(a.values.ItemID==ID_NEW){ItemPopupFunctions.showPopupWindow(0,b,InvoiceFunctions.refreshItemValues,null)}else{ItemPopupFunctions.getInformations(a.values.ItemID,b,InvoiceFunctions.refreshItemValues)}}else{if(typeof a.values.ProjectID!="undefined"){a.preventDefault();if(a.values.ProjectID==ID_NEW){ProjectPopupFunctions.showProjectPopup(0,InvoiceFunctions.refreshProjectValues,null,InvoiceFunctions.getSelectedCustomerId())}else{ProjectFunctions.getProjectInformations(a.values.ProjectID,InvoiceFunctions.refreshProjectValues)}}}}}}},invoiceDetailGrid_Edit:function(a){InvoiceFunctions.currentEditRow=$(a.container).closest("tr");NutcacheGridFunctions.autoSelectInputText(a.container)},getSelectedCustomerId:function(){return $("#InvoiceCustomerDropDownList").data("kendoDropDownList").value()},getProjectDropDownData:function(b){var c=NutcacheGridFunctions.getModelPropertyList(InvoiceFunctions.getServiceGrid(),InvoiceFunctions.getProductGrid(),function(d){return d.ProjectID});var a=InvoiceFunctions.getSelectedCustomerId();return{customerId:a,projectIds:c,isAddNewVisible:a!=0}},getItemDropDownData:function(a){var b=NutcacheGridFunctions.getModelPropertyList(InvoiceFunctions.getServiceGrid(),InvoiceFunctions.getProductGrid(),function(c){return c.ItemID});return{itemIds:b,isAddNewVisible:true}},getTaxDropDownData:function(a){var b=NutcacheGridFunctions.getModelPropertyList(InvoiceFunctions.getServiceGrid(),InvoiceFunctions.getProductGrid(),function(c){return c.TaxID});return{taxIds:b,isAddNewVisible:true}},setSelectedCustomer:function(a){var b=$("#InvoiceCustomerDropDownList").data("kendoDropDownList");b.dataSource.read().done(function(){b.value(a);b.trigger("change")})},customerDropDownList_Change:function(a){if(a.sender.value()==ID_NEW){CustomerPopupFunctions.showPopupWindow(0,function(b){InvoiceFunctions.setSelectedCustomer(b.ID);CustomerPopupFunctions.getCustomerInformations(b.ID,InvoiceFunctions.refreshCustomerValuesSuccess)},null);return}InvoiceFunctions.clearProjectValues(InvoiceFunctions.getServiceGrid());InvoiceFunctions.clearProjectValues(InvoiceFunctions.getProductGrid());if(a.sender.value()==0){InvoiceFunctions.refreshCustomerValuesSuccess(null)}else{CustomerPopupFunctions.getCustomerInformations(a.sender.value(),InvoiceFunctions.refreshCustomerValuesSuccess)}},customerDropDownList_Databound:function(a){if(a.sender.value()==0){InvoiceFunctions.refreshCustomerValuesSuccess(null)}else{CustomerPopupFunctions.getCustomerInformations(a.sender.value(),InvoiceFunctions.refreshCustomerValuesSuccess)}},editSelectedCustomer:function(){var a=InvoiceFunctions.getSelectedCustomerId();CustomerPopupFunctions.showPopupWindow(a,function(b){CustomerPopupFunctions.getCustomerInformations(b.ID,InvoiceFunctions.refreshCustomerValuesSuccess)},null)},indexGrid_onRecordSelected:function(b,a){var c=InvoiceFunctions.getInvoiceUrl()+"Edit/"+b.ID+Nutcache.QueryString.Referrer(true);if(a.ctrlKey||a.metaKey){window.open(c,"_blank")}else{Nutcache.Waitingwindow.Show();window.location=c}},indexGrid_onRecordSelectedForceNewTab:function(b,a){var c=InvoiceFunctions.getInvoiceUrl()+"Edit/"+b.ID+Nutcache.QueryString.Referrer(true);window.open(c,"_blank")},indexGrid_onDataBound:function(a){var b=a.dataSource.view();for(var c=0;c<b.length;c++){if(b[c].Status==7){a.table.find("tr[data-uid='"+b[c].uid+"']").addClass("deleted-row")}}},isInvoiceDirty:function(){var c=$(".invoice-main-area");if(c.length==0){return false}var b=Nutcache.ChangeDetection.FindChanges(c[0]);var e=InvoiceFunctions.getServiceGrid();var d=InvoiceFunctions.getProductGrid();var a=b.length>0||(e!=null?e.dataSource.hasChanges():false)||(d!=null?d.dataSource.hasChanges():false);return a},invoiceTitle_Edit:function(){var b=$("#CustomTitleSection");if(b.length){b.hide()}var c=$("#CustomTitleEditorSection");if(c.length){c.show()}var a=$("#CustomTitleDropdown");if(a.length){a.focus()}},invoiceTitle_Save:function(){var a=$("#CustomTitleSection");if(a.length){a.show()}var c=$("#CustomTitleEditorSection");if(c.length){c.hide()}SaveTag("Invoice","CustomTitleDropdown");var b=$("#CustomTitleDropdown").data("kendoComboBox");if(b!=undefined){if(b.selectedIndex==0){$("#CustomTitle").val("")}else{$("#CustomTitle").val(b.text().trim())}$(".invoicing-custom-title").text(b.text().trim())}},invoiceActionEdit:function(a){Nutcache.Waitingwindow.Show();window.location=InvoiceFunctions.getInvoiceUrl()+"Edit/"+a.recordId+Nutcache.QueryString.Referrer(true)},invoiceActionDuplicate:function(a){InvoiceFunctions.performDirtyCheckThenDo(a.menuData.messages.autoSaveConfirmTitle,a.menuData.messages.autoSaveConfirmMessage,function(){InvoiceFunctions.performInvoiceAction("Duplicate",{id:a.recordId},InvoiceFunctions.invoiceActionSuccess)})},invoiceActionDuplicateFromIndex:function(a){InvoiceFunctions.performInvoiceAction("Duplicate",{id:a.recordId},InvoiceFunctions.invoiceActionFromIndexSuccess)},invoiceActionDuplicateAsRecurrent:function(a){InvoiceFunctions.performDirtyCheckThenDo(a.menuData.messages.autoSaveConfirmTitle,a.menuData.messages.autoSaveConfirmMessage,function(){Nutcache.Waitingwindow.Show();var b=Nutcache.QueryString.Referrer(true);if(b==""){b="?referrer=Invoice"}window.location=InvoiceFunctions.getInvoiceUrl()+"DuplicateAsRecurrent/"+a.recordId+b})},invoiceActionDuplicateAsRecurrentFromIndex:function(a){Nutcache.Waitingwindow.Show();var b=Nutcache.QueryString.Referrer(true);if(b==""){b="?referrer=Invoice"}window.location=InvoiceFunctions.getInvoiceUrl()+"DuplicateAsRecurrent/"+a.recordId+b},invoiceActionUnlinkWorkingHourandExpense:function(a){OpenDialogWindow(a.menuData.messages.unlinkWorkedHourAndExpenseConfirmTitle,a.menuData.messages.unlinkWorkedHourAndExpenseConfirmMessage,function(){InvoiceFunctions.performInvoiceAction("UnlinkInvoiceWorkingHours",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionSuccess)})},invoiceActionUnlinkWorkingHourandExpenseFromIndex:function(a){OpenDialogWindow(a.menuData.messages.unlinkWorkedHourAndExpenseConfirmTitle,a.menuData.messages.unlinkWorkedHourAndExpenseConfirmMessage,function(){InvoiceFunctions.performInvoiceAction("UnlinkInvoiceWorkingHours",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionFromIndexSuccess)})},invoiceActionUnlinkEstimate:function(a){OpenDialogWindow(a.menuData.messages.unlinkEstimateConfirmTitle,a.menuData.messages.unlinkEstimateConfirmMessage,function(){InvoiceFunctions.performInvoiceAction("UnlinkEstimate",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionSuccess)})},invoiceActionUnlinkEstimateFromIndex:function(a){OpenDialogWindow(a.menuData.messages.unlinkEstimateConfirmTitle,a.menuData.messages.unlinkEstimateConfirmMessage,function(){InvoiceFunctions.performInvoiceAction("UnlinkEstimate",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionFromIndexSuccess)})},invoiceActionMakePayment:function(a){InvoiceFunctions.performDirtyCheckThenDo(a.menuData.messages.autoSaveConfirmTitle,a.menuData.messages.autoSaveConfirmMessage,function(){InvoiceFunctions.isInvoiceDirty()?InvoiceFunctions.save():InvoicePaymentFunctions.showPopupWindow(0,function(){window.location.href=InvoiceFunctions.getInvoiceUrl()+"Edit/"+$("#ID").val()+Nutcache.QueryString.Referrer(true)},null,a.recordId)})},invoiceActionMakePaymentFromIndex:function(a){InvoicePaymentFunctions.showPopupWindow(0,function(){NutcacheGridFunctions.refreshGrids("#gridInvoices,#gridInvoiceOverdue")},null,a.recordId)},invoiceActionSend:function(a){InvoiceFunctions.performDirtyCheckThenDo(a.menuData.messages.autoSaveConfirmTitle,a.menuData.messages.autoSaveConfirmMessage,function(){InvoiceFunctions.isInvoiceDirty()?InvoiceFunctions.saveInvoiceAndSend():InvoiceEmailFunctions.popupInvoiceSendEmailWindowForInvoice(a.recordId,a.recordVersion,function(){return SendInvoiceEmailFromInvoice(InvoiceEmailFunctions.sendEmailFromEditSuccess)})})},invoiceActionSendFromIndex:function(a){InvoiceEmailFunctions.popupInvoiceSendEmailWindowForInvoice(a.recordId,a.recordVersion,function(){return SendInvoiceEmailFromInvoice(InvoiceEmailFunctions.sendInvoiceSuccess)})},invoiceActionMarkAsViewed:function(a){InvoiceFunctions.performDirtyCheckThenDo(a.menuData.messages.autoSaveConfirmTitle,a.menuData.messages.autoSaveConfirmMessage,function(){InvoiceFunctions.performInvoiceAction("MarkInvoiceAsViewed",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionSuccess)})},invoiceActionMarkAsViewedFromIndex:function(a){InvoiceFunctions.performInvoiceAction("MarkInvoiceAsViewed",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionFromIndexSuccess)},invoiceActionSendReminder:function(a){InvoiceFunctions.performDirtyCheckThenDo(a.menuData.messages.autoSaveConfirmTitle,a.menuData.messages.autoSaveConfirmMessage,function(){InvoiceFunctions.isInvoiceDirty()?InvoiceFunctions.saveInvoice():InvoiceEmailFunctions.popupInvoiceSendReminderEmailWindowForInvoice(a.recordId,a.recordVersion,function(){return SendInvoiceReminderEmailFromInvoice(InvoiceEmailFunctions.sendEmailFromEditSuccess)})})},invoiceActionSendReminderFromIndex:function(a){InvoiceEmailFunctions.popupInvoiceSendReminderEmailWindowForInvoice(a.recordId,a.recordVersion,function(){return SendInvoiceReminderEmailFromInvoice(InvoiceEmailFunctions.sendInvoiceSuccess)})},invoiceActionMarkAsReminded:function(a){InvoiceFunctions.performDirtyCheckThenDo(a.menuData.messages.autoSaveConfirmTitle,a.menuData.messages.autoSaveConfirmMessage,function(){InvoiceFunctions.performInvoiceAction("MarkAsReminded",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionSuccess)})},invoiceActionMarkAsRemindedFromIndex:function(a){InvoiceFunctions.performInvoiceAction("MarkAsReminded",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionFromIndexSuccess)},invoiceActionVoid:function(a){InvoiceFunctions.performDirtyCheckThenDo(a.menuData.messages.autoSaveConfirmTitle,a.menuData.messages.autoSaveConfirmMessage,function(){InvoiceFunctions.performInvoiceAction("VoidInvoice",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionSuccess)})},invoiceActionVoidFromIndex:function(a){InvoiceFunctions.performInvoiceAction("VoidInvoice",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionFromIndexSuccess)},invoiceActionUnvoid:function(a){InvoiceFunctions.performDirtyCheckThenDo(a.menuData.messages.autoSaveConfirmTitle,a.menuData.messages.autoSaveConfirmMessage,function(){InvoiceFunctions.performInvoiceAction("UnVoidInvoice",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionSuccess)})},invoiceActionUnvoidFromIndex:function(a){InvoiceFunctions.performInvoiceAction("UnVoidInvoice",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionFromIndexSuccess)},invoiceActionDispute:function(a){InvoiceFunctions.performDirtyCheckThenDo(a.menuData.messages.autoSaveConfirmTitle,a.menuData.messages.autoSaveConfirmMessage,function(){InvoiceFunctions.performInvoiceAction("DisputeInvoice",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionSuccess)})},invoiceActionDisputeFromIndex:function(a){InvoiceFunctions.performInvoiceAction("DisputeInvoice",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionFromIndexSuccess)},invoiceActionUndispute:function(a){InvoiceFunctions.performDirtyCheckThenDo(a.menuData.messages.autoSaveConfirmTitle,a.menuData.messages.autoSaveConfirmMessage,function(){InvoiceFunctions.performInvoiceAction("UnDisputeInvoice",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionSuccess)})},invoiceActionUndisputeFromIndex:function(a){InvoiceFunctions.performInvoiceAction("UnDisputeInvoice",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionFromIndexSuccess)},invoiceActionDelete:function(b){var a=function(){InvoiceFunctions.performInvoiceAction("DeleteInvoice",{invoiceId:b.recordId,invoiceVersion:b.recordVersion},InvoiceFunctions.invoiceActionSuccess)};OpenDeleteDialogWindow(b.menuData.messages.deleteConfirmTitle,b.menuData.messages.deleteConfirmMessage,a)},invoiceActionDeleteFromIndex:function(a){OpenDeleteDialogWindow(a.menuData.messages.deleteConfirmTitle,a.menuData.messages.deleteConfirmMessage,function(){InvoiceFunctions.performInvoiceAction("DeleteInvoice",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionFromIndexSuccess)})},invoiceActionUndelete:function(a){InvoiceFunctions.performDirtyCheckThenDo(a.menuData.messages.autoSaveConfirmTitle,a.menuData.messages.autoSaveConfirmMessage,function(){InvoiceFunctions.performInvoiceAction("UnDeleteInvoice",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionSuccess)})},invoiceActionUndeleteFromIndex:function(a){InvoiceFunctions.performInvoiceAction("UnDeleteInvoice",{invoiceId:a.recordId,invoiceVersion:a.recordVersion},InvoiceFunctions.invoiceActionFromIndexSuccess)},invoiceExport:function(a){InvoiceFunctions.exportInvoice(a.config.exportType,a.menuData.messages.autoSaveConfirmTitle,a.menuData.messages.autoSaveConfirmMessage)},performDirtyCheckThenDo:function(c,b,a){if(InvoiceFunctions.isInvoiceDirty()){OpenDialogWindow(c,b,a)}else{a()}},newInvoice:function(){var d=function(){GoogleAnalyticsFunctions.TrackEvent("link","create","InvoiceFromPlusButton","0")};if(InvoiceFunctions.isInvoiceDirty()){var c=$("#HideDirtyConfirmationTitle").val();var b=$("#HideDirtyConfirmationMessage").val();var a=[{buttonClass:"nc-button nutcache-button ripplelink",onClickFunction:function(){d();InvoiceFunctions.saveInvoiceAndAddNew()},text:window.saveString},{buttonClass:"nc-button nutcache-button ripplelink",onClickFunction:function(){d();InvoiceFunctions.discardInvoiceAndAddNew()},text:window.discardString},{buttonClass:"nc-button nutcache-cancel-button ripplelink",onClickFunction:null,text:window.cancelString}];OpenDialogWindowWithButtons(c,b,a)}else{d();window.location=InvoiceFunctions.getInvoiceUrl("Create")}},getInvoiceData:function(){var a=[];a.push.apply(a,InvoiceFunctions.getServiceGrid().dataItems());a.push.apply(a,InvoiceFunctions.getProductGrid().dataItems());return{ID:$("#ID").val(),InvoiceNumber:$("#InvoiceNumber").val(),Status:$("#InvoiceStatus").val(),InvoiceDate:Nutcache.Dates.ToISODateString($("#InvoiceDate").data("kendoDatePicker").value()),DueDate:Nutcache.Dates.ToISODateString($("#DueDate").data("kendoDatePicker").value()),Description:$("#Description").val(),PONumber:$("#PONumber").val(),CustomerId:$("#InvoiceCustomerDropDownList").val(),CustomerEmail:$("#CustomerEmail").val(),CustomerContact:$("#CustomerContact").val(),CustomerName:$("#CustomerName").val(),CustomerCountry:$("#CustomerCountry").val(),CustomerAddress:$("#CustomerAddress").val(),CustomerCity:$("#CustomerCity").val(),CustomerProvinceState:$("#CustomerProvinceState").val(),CustomerPostalZipCode:$("#CustomerPostalZipCode").val(),CustomerPhone:$("#CustomerPhone").val(),CustomerPhoneMobile:$("#CustomerPhoneMobile").val(),CustomerLegalNotice:$("#CustomerLegalNotice").val(),TotalAmountBeforeTaxes:$("#TotalAmountBeforeTaxes").val(),TaxesAmount:$("#TaxesAmount").val(),TotalAmountAfterTaxes:$("#TotalAmountAfterTaxes").val(),AmountDue:$("#AmountDue").val(),AmountPaid:$("#AmountPaid").val(),InvoiceNotes:$("#InvoiceNotes").val(),InvoiceTerms:$("#InvoiceTerms").val(),CustomTitle:$("#CustomTitle").val(),EstimateId:$("#EstimateId").val(),EstimateVersion:$("#EstimateVersion").val(),ResponsibleId:$("#ResponsibleId").val(),Version:$("#Version").val(),InvoiceDetails:a}},saveInvoiceAndAddNew:function(c){var b=$("#ID",".transaction-section-container").val();var a=(typeof b=="undefined"||b=="0")?"CreateAndAddNew":"EditAndAddNew";InvoiceFunctions._saveInvoice(a,c)},discardInvoiceAndAddNew:function(){window.location=InvoiceFunctions.getInvoiceUrl("Create")},saveInvoice:function(c){var b=$("#ID",".transaction-section-container").val();var a=(typeof b=="undefined"||b=="0")?"Create":"Edit";InvoiceFunctions._saveInvoice(a,c)},_saveInvoice:function(a,b){var c=$("#uploadsInProgress");if(c.length==0||c.val()=="0"){Nutcache.Waitingwindow.Show();Nutcache.Ajax.TryAjaxCall({url:InvoiceFunctions.getInvoiceUrl()+a,contentType:"application/json; charset=utf-8",type:"POST",data:JSON.stringify({invoiceEditViewModel:InvoiceFunctions.getInvoiceData()}),dataType:"json",success:function(d){Nutcache.Waitingwindow.Hide();if(!d.IsSaved&&d.IsRedirect){ShowErrors(d)}else{if(d.IsSaved){if(d.IsRedirect){Nutcache.AutoCallback.addSingleCall(LoadMessagesSection,d.Messages,"#floating-message-window");Nutcache.AutoCallback.addSingleCall(b);window.location=d.Content}else{InvoiceFunctions.refreshInvoice(b);LoadMessagesSection(d.Messages,"#floating-message-window")}}}LoadMessagesSection(d.Messages,"#floating-message-window")},error:ManageAjaxError})}else{ShowErrorMessages($("#uploadsInProgressText").val())}},saveInvoiceAndSend:function(){var a=function(){InvoiceEmailFunctions.popupInvoiceSendEmailWindowForInvoice($("#ID").val(),$("#Version").val(),function(){return SendInvoiceEmailFromInvoice(InvoiceEmailFunctions.sendEmailFromEditSuccess)})};InvoiceFunctions.saveInvoice(a)},performInvoiceAction:function(a,b,c){if(a!=""){Nutcache.Waitingwindow.Show();Nutcache.Ajax.TryAjaxCall({url:InvoiceFunctions.getInvoiceUrl()+a,contentType:"application/json; charset=utf-8",type:"POST",data:JSON.stringify(b),dataType:"json",success:function(d){Nutcache.Waitingwindow.Hide();c(d)},error:ManageAjaxError})}return true},invoiceActionSuccess:function(a){if(!a.IsSaved&&a.IsRedirect){ShowErrors(a)}else{if(a.IsSaved){if(a.IsRedirect){Nutcache.AutoCallback.addSingleCall.call(this,LoadMessagesSection,a.Messages,"#floating-message-window");window.location=a.Content}else{InvoiceFunctions.refreshInvoice();LoadMessagesSection(a.Messages,"#floating-message-window")}}}},invoiceActionFromIndexSuccess:function(a){if(!a.IsSaved&&a.IsRedirect){ShowErrors(a)}else{if(a.IsSaved){NutcacheGridFunctions.refreshGrids("#gridInvoices,#gridInvoiceOverdue");LoadMessagesSection(a.Messages,"#floating-message-window")}}},getInvoiceSummary:function(a,b){Nutcache.Ajax.TryAjaxCall({url:InvoiceFunctions.getInvoiceUrl("GetSummary"),contentType:"application/json; charset=utf-8",type:"POST",data:JSON.stringify({invoiceId:a}),dataType:"json",success:function(c){if(c.IsSaved&&b){b(c.Content)}},error:ManageAjaxError})},refreshBubbleCounts:function(){var a=InvoiceFunctions.getCurrentInvoiceId();if((typeof a!="undefined")&&(a>0)){InvoiceFunctions.getInvoiceSummary(a,function(b){InvoiceFunctions.refreshBubbleCount($("#tabPayments .bubble-count"),b.PaymentsCount);InvoiceFunctions.refreshBubbleCount($("#tabAttachments .bubble-count"),b.AttachmentsCount);InvoiceFunctions.refreshBubbleCount($("#tabNotes .bubble-count"),b.NotesCount)})}},refreshBubbleCount:function(b,a){if(a>0){b.show();b.text(a>99?"99+":a)}else{b.hide()}},refreshInvoice:function(b){InvoiceFunctions.refreshBubbleCounts();var a=InvoiceFunctions.getCurrentInvoiceId();Nutcache.Ajax.TryAjaxCall({url:InvoiceFunctions.getInvoiceUrl("RenderEditView"),contentType:"application/json; charset=utf-8",type:"POST",data:JSON.stringify({invoiceId:a}),dataType:"json",success:function(d){if(d.InvoiceMainHeaderPartial.length){$(".main-header-section").replaceWith(d.InvoiceMainHeaderPartial)}var e=$(d.TabInvoicePartial).find(".transaction-section-container");if(e.length){$(".transaction-section-container").replaceWith(e)}$("#tabStripInvoice").data("kendoTabStrip").reload("#tabPayments");var c=$("#gridInvoiceActivities").data("kendoGrid");if($("#tabStripInvoice").data("kendoTabStrip").select()[0].id=="tabActivity"){c.dataSource.read()}else{c.dataSource.data([])}Nutcache.AutoCallback.executeCallback(b)},error:ManageAjaxError})},onAttachmentDeleteConfirmed:function(a){Nutcache.Ajax.TryAjaxCall({url:InvoiceFunctions.getInvoiceUrl("DeleteAttachment"),contentType:"application/json; charset=utf-8",type:"POST",dataType:"json",data:JSON.stringify({ID:a.data("id")}),success:function(b){if(b.IsSaved){$(".attachment-container[data-id="+a.data("id")+"]").remove();AttachmentFunctions.removeAttachmentConfirmed(a)}LoadMessagesSection(b.Messages,"#floating-message-window")},error:ManageAjaxError},true)},toggleCustomerVisibility:function(a,b){Nutcache.Ajax.TryAjaxCall({url:GetUrl("Invoice")+"SetAttachmentCustomerVisibility",contentType:"application/x-www-form-urlencoded; charset=UTF-8",type:"POST",data:{id:a,visibleToCustomer:b},success:function(c){},error:ManageAjaxError})},previewInvoiceReport:function(c,d,b){if(InvoiceFunctions.isInvoiceDirty()){OpenDialogWindow(d,b,function(){InvoiceFunctions.saveInvoice(Nutcache.AutoCallback.createCallback(InvoiceFunctions.previewInvoiceReport,c,d,b))});return false}var e=GetUrl("Report");var a=$("#CompanyGuid").val();if(a){e+="GetInvoiceReportExternal?hashedUrl="+c}else{e+="GetInvoiceReport?id="+c}window.open(e,"_blank");return false},exportInvoice:function(c,e,b){if(InvoiceFunctions.isInvoiceDirty()){OpenDialogWindow(e,b,function(){InvoiceFunctions.saveInvoice(Nutcache.AutoCallback.createCallback(InvoiceFunctions.exportInvoice,c,e,b))});return false}Nutcache.Waitingwindow.Show();var d=$("#ID").val();var f=GetUrl("Report")+"ExportInvoice?invoiceId="+d+"&extensionType="+c;var a=$("#CompanyGuid").val();if(a){f+="&companyguid="+a}window.location.href=f;Nutcache.Waitingwindow.Hide();return false},invoiceTabChanged:function(a){if(a.item.id=="tabActivity"){var b=$("#gridInvoiceActivities").data("kendoGrid");if(b.dataSource.total()==0){NutcacheGridFunctions.loadConfig("#gridInvoiceActivities")}}else{if(a.item.id=="tabMainInfos"){evaluateFloatingBottomAction()}}}};