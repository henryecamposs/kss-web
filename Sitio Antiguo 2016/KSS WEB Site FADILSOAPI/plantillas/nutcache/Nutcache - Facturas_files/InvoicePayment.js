var InvoicePaymentFunctions={observers:new Array(),notifyObservers:function(){if(InvoicePaymentFunctions.observers!=null&&InvoicePaymentFunctions.observers.length>0){$.each(InvoicePaymentFunctions.observers,function(){this()})}},getInvoicePaymentUrl:function(a){return GetUrl("InvoicePayment")+(a!=null?a:"")},showPopupWindow:function(d,f,a,c,b){var g=InvoicePaymentFunctions.getInvoicePaymentUrl("GetView")+"?"+$.param({id:d,invoiceId:c,customerId:b});var e=PopupWindowFunctions.getPopupWindow("InvoicePaymentCreateEditPopup","ID",d);if(e!=null){PopupWindowFunctions.refreshPopupWindowContent(e,g,function(){InvoicePaymentFunctions.setSuccessJsCallbackFunction(e.wrapper,f)})}else{PopupWindowFunctions.openPopupWindow(g,function(h){InvoicePaymentFunctions.save(h,f)},a,function(h){InvoicePaymentFunctions.setSuccessJsCallbackFunction(h.wrapper,f)})}},save:function(d,e){var b=$("#ID",d.wrapper).val();var a=(typeof b=="undefined"||b=="0"||b=="")?"Create":"Edit";var c=InvoicePaymentFunctions.getData(d.wrapper);if(c!=null){Nutcache.Ajax.TryAjaxCall({url:InvoicePaymentFunctions.getInvoicePaymentUrl(a),contentType:"application/json; charset=utf-8",type:"POST",data:JSON.stringify(c),dataType:"json",success:function(f){InvoicePaymentFunctions.saveSuccess(d,f,e)},error:ManageAjaxError})}},saveSuccess:function(b,a,c){if(a.IsRedirect){b.close()}else{if(a.IsSaved){b.close();if(c){c(a.Content)}InvoicePaymentFunctions.notifyObservers()}else{b.content(a.Content)}}LoadMessagesSection(a.Messages,"#floating-message-window")},getData:function(a){var b={ID:$("#ID",a).val(),Date:Nutcache.Dates.ToISODateString($("#Date",a).data("kendoDatePicker").value()),Note:$("#Note",a).val(),PaymentGatewayUID:$("#PaymentGatewayUID",a).val(),PaymentGatewayResult:$("#PaymentGatewayResult",a).val(),Amount:$("#Amount",a).val(),PaymentMethod:$("#PaymentMethod",a).val(),InvoiceId:$("#Invoice_ID",a).val(),CustomerId:$("#CustomerId",a).val(),HideInvoiceDropDown:$("#HideInvoiceDropDown",a).val(),InvoiceNumber:$("#InvoiceNumber",a).val(),CustomerName:$("#CustomerName",a).val(),TotalAmountDue:$("#TotalAmountDue",a).val(),Version:$("#Version",a).val(),InvoiceVersion:$("#InvoiceVersion",a).val(),SuccessJsCallbackFunction:$("#SuccessJsCallbackFunction",a).val()};return b},setSuccessJsCallbackFunction:function(a,b){$("#SuccessJsCallbackFunction",a).val(String(b).replace(/"/g,"'"))},deleteInvoicePayment:function(a,b){Nutcache.Ajax.TryAjaxCall({url:InvoicePaymentFunctions.getInvoicePaymentUrl("Delete"),contentType:"application/x-www-form-urlencoded; charset=UTF-8",type:"GET",dataType:"json",data:{id:a},success:function(c){if(c.IsSaved){if(b){b(c)}InvoicePaymentFunctions.notifyObservers()}LoadMessagesSection(c.Messages,"#floating-message-window")},error:ManageAjaxError})},RefreshInvoiceInformation:function(){var a=$("#Invoice_ID");if($("#Invoice_ID").val()!=""){Nutcache.Ajax.QueueAjaxCall(a,{url:InvoicePaymentFunctions.getInvoicePaymentUrl("GetInvoiceInformation"),contentType:"application/x-www-form-urlencoded; charset=UTF-8",type:"POST",data:{invoiceId:$("#Invoice_ID").val(),paymentId:$("#ID").val()},dataType:"json",success:function(b){$("#bigAmountDue").text(b.Content.InvoiceAmountFormatted);$("#Amount").data("kendoNumericTextBox").value(b.Content.InvoiceAmountFormatted)},error:ManageAjaxError},100)}},actionEdit:function(a){InvoicePaymentFunctions.showPopupWindow(a.recordId,function(){NutcacheGridFunctions.refreshGrids("#gridInvoicePayments")})},actionDelete:function(a){OpenDeleteDialogWindow(a.menuData.messages.deleteConfirmTitle,a.menuData.messages.deleteConfirmMessage,function(){InvoicePaymentFunctions.deleteInvoicePayment(a.recordId,function(){NutcacheGridFunctions.refreshGrids("#gridInvoicePayments")})})}};var PayNowFunctions={getExternalUrl:function(a){return GetUrl("ExternalUrl")+(a!=null?a:"")},showPayNowPopupWindow:function(b){var a=$("#CompanyGuid").val();if(b>0){Nutcache.Waitingwindow.Show();Nutcache.Ajax.TryAjaxCall({url:InvoicePaymentFunctions.getInvoicePaymentUrl("PayNow"),contentType:"application/json; charset=utf-8",type:"GET",data:{invoiceId:b,companyGuid:a},dataType:"json",success:function(c){Nutcache.Waitingwindow.Hide();if(c.IsSaved){var d=GetWindowObject();d.content(c.Content);d.title(c.Title);d.center().open()}else{ShowErrors(c)}},error:ManageAjaxError})}},getPayNowData:function(){var a={CompanyGuid:$("#popup-window  #CompanyGuid").val(),InvoiceId:$("#popup-window  #Invoice_Id").val(),Amount:$("#popup-window  #Amount").val(),PaymentGateway:PayNowFunctions.getPaymentGatewayType(),RelayUrl:$("#Relay_Url").val()};return a},getPaymentGatewayType:function(){var a=null;var b=$(".payment-gateway-button-selected")[0];if((typeof b)!="undefined"){a=b.id}return a},payNowAction:function(){var a=PayNowFunctions.getPaymentGatewayType();if(a=="Stripe"){PayNowFunctions.processStripePayNow()}else{PayNowFunctions.postInvoicePaymentPayNow()}},postInvoicePaymentPayNow:function(){Nutcache.Waitingwindow.Show();var a=JSON.stringify(PayNowFunctions.getPayNowData());Nutcache.Ajax.TryAjaxCall({url:InvoicePaymentFunctions.getInvoicePaymentUrl("PayNow"),contentType:"application/json; charset=utf-8",type:"POST",data:a,dataType:"json",success:function(b){Nutcache.Waitingwindow.Hide();var c=GetWindowObject();c.content(b.Content);if(!b.IsSaved){if(b.IsRedirect){ShowErrors(b)}else{UpdatePopupWindowContent(b)}}},error:ManageAjaxError})},processStripePayNow:function(){var a=$("#popup-window  #Amount").val();ClosePopupWindow();PayNowFunctions.openStripePopup(a)},openStripePopup:function(a){if(typeof window.$stripeHandler!=="undefined"&&a!=="undefined"){window.$stripeAmount=(kendo.parseFloat(a)*Math.pow(10,Nutcache.FormatInfo.CurrencyDecimalCount)).toFixed(0);window.$stripeHandler.open({amount:window.$stripeAmount})}},processStripeResult:function(f,b){var e=$(".external-invoice-container #ID").val();var d=$(".external-invoice-container #CompanyGuid").val();var c=$(".external-invoice-container #CompanyCurrency").val();var a=0;if(typeof window.$stripeAmount!=="undefined"){a=window.$stripeAmount}Nutcache.Ajax.TryAjaxCall({url:PayNowFunctions.getExternalUrl("ProcessStripeResult"),contentType:"application/x-www-form-urlencoded; charset=UTF-8",type:"POST",data:{token_id:f.id,invoice_id:e,amount:a,nutcache_company_guid:d,currency:c},dataType:"json",success:function(g){location.reload()},error:ManageAjaxError})}};$(document).on("click","div.payment-gateway-button",function(){$(this).parent().find(".payment-gateway-button").removeClass("payment-gateway-button-selected");$(this).addClass("payment-gateway-button-selected")});function InvoicePaymentsIndexGrid_OnRecordSelected(b,a){InvoicePaymentFunctions.showPopupWindow(b.ID,function(){NutcacheGridFunctions.refreshGrids("#gridInvoicePayments")})};