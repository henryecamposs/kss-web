(function(a){a.fn.tokenField=function(i){var l={regex:/^(([\w-]+\.)+[\w-]+|([\w]{1}|[\w-]{2,}))@[\w-\.]*(([\w]+[\w-]+\.)+[\w]+)$/i,delimiters:", ;",max:0,nested:false,badToken:function(){a(this).val("")},tooMany:function(){a(this).val("")}};if(i){a.extend(l,i)}function b(o){try{console.log(o)}catch(n){}}function c(n,o){return a.map(o,function(p){return m(n,p)}).join("")}function d(n){return"<div class='token-input'><input type='text' size='1'/><span class='token-input-sizer'>###</span></div>"}function e(n){return String.fromCharCode(n).match(RegExp("["+l.delimiters+"]"))}function f(n){return n.match(l.regex)}function h(n){n.click(function(){a(".token-input",this).siblings(".selected-token").removeClass("selected-token");a(".token-input input",this).focus();return false});a(".token-input input",n).keydown(function(o){if(o.which==9&&a(this).val()){a(this).blur();a(this).focus();return false}return true}).keypress(function(o){a(this).next(".token-input-sizer").html(a(this).val()+"###");if(o.which==13||e(o.which)){a(this).blur();if(e(o.which)){a(this).focus()}return false}return true}).keyup(function(){a(this).next(".token-input-sizer").html(a(this).val()+"###");return true}).focus(function(){a(this).next(".token-input-sizer").html(a(this).val()+"###");return true}).blur(function(o){if(!a(this).data("blur")){a(this).data("blur",true);if(l.max==0||a(this).closest(".token-input").siblings(".token").length<l.max){if(f(a(this).val())){g(a(m(a(this).attr("name"),a(this).val())).insertBefore(a(this).closest(".token-input")));if(!l.nested){var p=a(this).closest(".token-field").find("input:hidden");var q=p.val().split(",");q.push(a(this).val());var r=q.join(",");if(r.charAt(0)!=","){r=","+r}p.val(r)}a(this).val("")}else{if(l.badToken){this.badToken=l.badToken;this.badToken()}}}else{if(l.tooMany){this.tooMany=l.tooMany;this.tooMany()}}a(this).removeData("blur")}return true});g(a(".token",n))}function g(n){n.click(function(){a(this).focus();return false}).keydown(function(o){if(a(this).hasClass("selected-token")){if(o.which==8){k(a(this));return false}}return true}).blur(function(){a(this).removeClass("selected-token")}).focus(function(){a(this).siblings(".selected-token").removeClass("selected-token");a(this).addClass("selected-token")});a(".token-x",n).click(function(){a(this).closest(".token").siblings(".selected-token").removeClass("selected-token");k(a(this).closest(".token"));return false})}function j(n){n=n.replace(/^\s*(.+)\s*$/,"$1");if(!n){return[]}return a.map(n.split(","),function(o){if(f(o)){return o}b("Warning: ignoring bad token - "+o);return null})}function k(p){if(!l.nested){var n=p.siblings(".token").andSelf().index(p)+1;var o=p.closest(".token-field").find("input:hidden");var r=o.val();if(r.charAt(0)!=","){r=","+r}var q=r.split(",");q.splice(n,1);o.val(q.join(","))}p.remove()}function m(n,o){return"<a href='#' class='token'><span><span><span><span>"+o+(l.nested?"<input type='hidden' value='"+o+"' name='"+n+"'/>":"")+"<span href='#' class='token-x'>x</span></span></span></span></span></a>"}return this.each(function(){var p=a(this).attr("id");var r=a(this).attr("name");var q=a(this).attr("class");var u="";var n=a(this).data(),s={};var v=j(a(this).val());if(a(this).width()>0){u=u+"width: "+a(this).width()+"px;"}if(l.max>0&&v.length>l.max){b("Warning: ignoring extra tokens after maximum of "+l.max);v=v.slice(0,l.max)}for(var t in n){s["data-"+t]=n[t]}var o=a("<div></div>").attr(a.extend({"class":q,id:p,style:u},s)).data(n).addClass("token-field").append(c(r,v)).append(d(r)).replaceAll(this);if(!l.nested){o.prepend("<input type='hidden' value='"+v.join(",")+"' name='"+r+"'/>")}h(o)})}})(jQuery);